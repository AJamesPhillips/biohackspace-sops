#!/usr/bin/python

import os
pw = os.environ['BIOBOT_PW']

from wikitools import wiki
from wikitools import api
from wikitools import category
from wikitools import page

# create a Wiki object
site = wiki.Wiki("https://wiki.london.hackspace.org.uk/w/api.php") 
# login - required for read-restricted wikis
login = site.login("biobot", pw)


#lbl01001 lbl02001 lbl03001 lbl04001 lbl04002 lbl04003 lbl04004 lbl04005 lbl04006 lbl04007 lbl04008 lbl05001 lbl06001 lbl07001 lbl07002 lbl07003 lbl07004 lbl07005 lbl08001 lbl08002 lbl08003
for content in ['lbl08001']:

  #this is the content, should have already been generated by Makefile
  pagetext = open("mwiki/"+content.lower()+".wiki").read()

  #get page from api.php
  page = page.Page(site, content.upper())

  # try an edit, this will fail with captcha
  myedit = page.edit(text=pagetext, bot=1, summary='Sync from github', answer="Hackney Road")

  print(repr(myedit))

  # this is the edit session token
  print(page.getToken('edit'))

  if myedit['edit']['result'] == 'Failure':
    id=myedit['edit']['captcha']['id']
    
    # provide the captcha text as query param "answer"
    params = {'action':'edit', 'title':content.upper(),'bot':1,'id':id,'answer':"Hackney Road",'text':pagetext,'token':page.getToken('edit')}
    request = api.APIRequest(site, params)
    # query the API
    result = request.query()
    print(result)


